#!/usr/bin/env bash
# Git workflow cheatsheet for daytrading_platform
# Run commands line-by-line, not as a single script ðŸ™‚


##############################################
# 0. Update local main
##############################################

# Make sure you are on main
git checkout main

# Pull latest from GitHub
git pull origin main


##############################################
# 1. Start a new feature/bug branch
##############################################

# Create and switch to a new branch from main
git checkout -b feature/my-feature-name
# or for bugs:
# git checkout -b bug/fix-something


##############################################
# 2. Work, commit, push
##############################################

# See what changed
git status

# Stage files you changed
git add path/to/file1 path/to/file2
# or all changes:
# git add .

# Commit with a clear message
git commit -m "feat: describe the change"

# First push: create the remote branch and set upstream
git push -u origin feature/my-feature-name


##############################################
# 3. Keep branch up-to-date with main
##############################################

# Fetch latest state from GitHub
git fetch origin

# Rebase your feature branch onto the latest main
git rebase origin/main

# After a rebase, push with --force-with-lease to update remote safely
git push --force-with-lease


##############################################
# 4. Run local CI before creating / finishing a PR
##############################################

# Make sure your dev DB etc. are available and run local CI
make ci
# (backend checks + tests + frontend build, mirroring GitHub CI)


##############################################
# 5. Open / finalize Pull Request (GitHub UI)
##############################################

# Go to GitHub:
# - Open PR from feature/my-feature-name â†’ main
# - CI should run and be green
# - Review, then click "Merge" in GitHub when ready

# After the PR is merged, sync local main:
git checkout main
git pull origin main


##############################################
# 6. Tag a successful deployment (from main)
##############################################

# After a successful deploy from main (via GitHub Actions),
# create a tag on main as a restore point.

git checkout main
git pull origin main

# Create a tag (adjust name/date as needed, e.g. deploy-2025-11-27)
git tag deploy-2025-11-27

# Push the tag to GitHub
git push origin deploy-2025-11-27


##############################################
# 7. Cleanup old branches after merge
##############################################

# List branches that are fully merged into main
git branch --merged main

# Delete a merged local branch (safe)
git branch -d feature/my-feature-name

# Prune remote-tracking branches that were deleted on GitHub
git fetch --prune origin

# List all local and remote branches, just to check
git branch -a


##############################################
# 8. Start the next feature from a clean main
##############################################

git checkout main
git pull origin main

git checkout -b feature/next-roadmap-item


##############################################
# 9. Rollback using a deploy tag (protected main)
##############################################
# Goal: main on GitHub should point back to a known-good deploy tag.
# This fits your protected-main setup and keeps the CI/CD deploy flow intact.

# 9.1 On your Mac: create a rollback branch *from the tag*
git checkout main
git pull origin main

# Create rollback branch starting from the known-good tag
git checkout -b rollback/to-deploy-2025-11-27 deploy-2025-11-27

# Push the rollback branch to GitHub
git push -u origin rollback/to-deploy-2025-11-27

# 9.2 On GitHub (web UI):
# - Open a Pull Request: base = main, compare = rollback/to-deploy-2025-11-27
# - CI ("CI" workflow) must be green
# - Merge the PR into main

# 9.3 Result after merge:
# - A push to main happens
# - Your "Deploy Production" workflow is triggered
# - The self-hosted runner rsyncs main â†’ /opt/daytrading_platform/daytrading_platform
# - Docker images/containers are rebuilt and restarted
# => Production is now rolled back to the code of deploy-2025-11-27

# No git commands need to run on the VPS itself; the runner
# already deploys the current main to the VPS.


##############################################
# 10. (Optional / Rare) True history rewind
##############################################
# NOTE: With protected main, this is normally NOT used.
# It would require temporarily relaxing protection on main.
# Keep this as documentation only.

# If one day you *really* want to hard-reset main on GitHub:
#  - Temporarily allow force-pushes on main in GitHub settings
#  - Then, on your Mac:

# git checkout main
# git pull origin main
# git reset --hard deploy-2025-11-27
# git push --force origin main

# After that, re-enable branch protection.
# Your normal rollback flow should remain section 9 (rollback branch + PR).
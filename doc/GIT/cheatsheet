#!/usr/bin/env bash
# Git workflow cheatsheet for daytrading_platform
# Run commands line-by-line, not as a single script ðŸ™‚
#
# Concept:
# - main  = always deployable, what runs on the VPS
# - dev   = long-living integration branch where you do daily work
# - Deploys happen from main only (via GitHub Actions)
# - Tags mark successful deploys


##############################################
# 0. One-time setup: create dev branch
##############################################

# Start on main and make sure it's up-to-date
git checkout main
git pull origin main

# Create dev from main (only once)
git checkout -b dev
git push -u origin dev


##############################################
# 1. Start your day: sync main & dev
##############################################

# Make sure main is up to date
git checkout main
git pull origin main

# Go to dev and merge latest main into dev
git checkout dev
git fetch origin
git merge origin/main      # or: git rebase origin/main


##############################################
# 2. Work on dev: code, commit, push
##############################################

# See what changed
git status

# Stage files you changed
git add path/to/file1 path/to/file2
# or all changes:
# git add .

# Commit with a clear message
git commit -m "feat: describe the change"
# examples:
# git commit -m "fix: restore screenshot URLs after deploy"
# git commit -m "feat: add trade journal filters"

# Push dev to GitHub
git push origin dev


##############################################
# 3. Keep dev clean during longer work
##############################################

# If main has moved while you're still working on dev:
git checkout main
git pull origin main

git checkout dev
git fetch origin
git merge origin/main      # or: git rebase origin/main

# Then push updated dev
git push origin dev


##############################################
# 4. Run local CI before releasing dev â†’ main
##############################################

# Make sure your dev DB etc. are available and run local CI
make ci
# (backend checks + tests + frontend build, mirroring GitHub CI)


##############################################
# 5. Prepare and merge PR: dev â†’ main
##############################################

# Make sure dev contains latest main and your work
git checkout main
git pull origin main

git checkout dev
git fetch origin
git merge origin/main      # or rebase if you prefer

git push origin dev

# Then go to GitHub:
# - Open PR: base = main, compare = dev
# - CI should run and be green
# - Review the diff and click "Merge" when ready

# After PR is merged, sync local main & dev:

git checkout main
git pull origin main       # main now contains your changes

git checkout dev
git merge origin/main      # keep dev aligned with main
git push origin dev


##############################################
# 6. Tag a successful deployment (from main)
##############################################

# After a successful deploy from main (via GitHub Actions),
# create a tag on main as a restore point.

git checkout main
git pull origin main

# Create a tag (adjust name/date as needed, e.g. deploy-2025-11-27)
git tag deploy-2025-11-27

# Push the tag to GitHub
git push origin deploy-2025-11-27


##############################################
# 7. Start the next development cycle
##############################################

# Always start from synced main & dev

git checkout main
git pull origin main

git checkout dev
git merge origin/main      # or rebase
git push origin dev

# Now continue working on dev as in sections 2â€“4


##############################################
# 8. Rollback using a deploy tag (protected main)
##############################################
# Goal: main on GitHub should point back to a known-good deploy tag.
# This fits your protected-main setup and keeps the CI/CD deploy flow intact.

# 8.1 On your Mac: create a rollback branch *from the tag*
git checkout main
git pull origin main

# Create rollback branch starting from the known-good tag
git checkout -b rollback/to-deploy-2025-11-27 deploy-2025-11-27

# Push the rollback branch to GitHub
git push -u origin rollback/to-deploy-2025-11-27

# 8.2 On GitHub (web UI):
# - Open a Pull Request: base = main, compare = rollback/to-deploy-2025-11-27
# - CI ("CI" workflow) must be green
# - Merge the PR into main

# 8.3 Result after merge:
# - A push to main happens
# - Your "Deploy Production" workflow is triggered
# - The self-hosted runner rsyncs main â†’ /opt/daytrading_platform/daytrading_platform
# - Docker images/containers are rebuilt and restarted
# => Production is now rolled back to the code of deploy-2025-11-27

# No git commands need to run on the VPS itself; the runner
# already deploys the current main to the VPS.


##############################################
# 9. (Optional / Rare) True history rewind
##############################################
# NOTE: With protected main, this is normally NOT used.
# It would require temporarily relaxing protection on main.
# Keep this as documentation only.

# If one day you *really* want to hard-reset main on GitHub:
#  - Temporarily allow force-pushes on main in GitHub settings
#  - Then, on your Mac:

# git checkout main
# git pull origin main
# git reset --hard deploy-2025-11-27
# git push --force origin main

# After that, re-enable branch protection.
# Your normal rollback flow should remain section 8 (rollback branch + PR).
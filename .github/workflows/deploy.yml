name: CI & Deploy

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build Django image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Django image
        working-directory: ./django
        run: |
          docker build -t daytrading_app:ci .

  deploy:
    name: Deploy to VPS
    needs: build
    runs-on: ubuntu-latest

    # Optional: only run deploy when VPS secrets are configured
    if: ${{ secrets.VPS_HOST != '' && secrets.VPS_USER != '' && secrets.VPS_SSH_KEY != '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SSH client
        run: sudo apt-get update && sudo apt-get install -y openssh-client

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PROJECT_DIR: ${{ secrets.VPS_PROJECT_DIR }}
        run: |
          ssh "$VPS_USER@$VPS_HOST" << 'EOF'
          set -e
          cd "$VPS_PROJECT_DIR"
          git pull
          make prod-up
          EOF